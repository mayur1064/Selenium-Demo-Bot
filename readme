provider "azurerm" {
  features {}
}

# Replace with your values
variable "resource_group_name" {
  default = "my-resource-group"
}

variable "location" {
  default = "East US"
}

variable "key_vault_name" {
  default = "my-existing-kv"
}

variable "app_insights_name" {
  default = "my-appinsights"
}

variable "key_vault_resource_group" {
  default = "kv-resource-group"  # Set this to the resource group where Key Vault exists
}

# Get existing Key Vault
data "azurerm_key_vault" "kv" {
  name                = var.key_vault_name
  resource_group_name = var.key_vault_resource_group
}

# Create Application Insights
resource "azurerm_application_insights" "app_insights" {
  name                = var.app_insights_name
  location            = var.location
  resource_group_name = var.resource_group_name
  application_type    = "web"
}

# Store the Instrumentation Key in the existing Key Vault
resource "azurerm_key_vault_secret" "app_insights_key" {
  name         = "appInsightsInstrumentationKey"
  value        = azurerm_application_insights.app_insights.instrumentation_key
  key_vault_id = data.azurerm_key_vault.kv.id
}
