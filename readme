provider "azurerm" {
  features {}
}

# Data block to get existing UAMI
data "azurerm_user_assigned_identity" "uami" {
  name                = "my-uami"
  resource_group_name = "my-uami-rg"
}

# Data block to get existing Key Vault
data "azurerm_key_vault" "kv" {
  name                = "my-keyvault"
  resource_group_name = "my-kv-rg"
}

# Assign access policy to UAMI
resource "azurerm_key_vault_access_policy" "uami_access" {
  key_vault_id = data.azurerm_key_vault.kv.id
  tenant_id    = data.azurerm_user_assigned_identity.uami.tenant_id
  object_id    = data.azurerm_user_assigned_identity.uami.principal_id

  secret_permissions = [
    "get",
    "list",
    "set"
  ]

  key_permissions = [
    "get",
    "list",
    "decrypt",
    "encrypt"
  ]

  certificate_permissions = []
  storage_permissions     = []
}
