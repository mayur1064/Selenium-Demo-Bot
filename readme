provider "azurerm" {
  features {}
}

# Replace with your values
variable "resource_group_name" {
  default = "your-resource-group"
}

variable "location" {
  default = "East US"
}

variable "log_analytics_workspace_name" {
  default = "my-law-workspace"
}

variable "existing_key_vault_name" {
  default = "my-existing-kv"
}

variable "kv_resource_group" {
  default = "your-kv-resource-group"
}

# Create Log Analytics Workspace
resource "azurerm_log_analytics_workspace" "law" {
  name                = var.log_analytics_workspace_name
  location            = var.location
  resource_group_name = var.resource_group_name
  sku                 = "PerGB2018"
  retention_in_days   = 30
}

# Get the existing Key Vault
data "azurerm_key_vault" "existing_kv" {
  name                = var.existing_key_vault_name
  resource_group_name = var.kv_resource_group
}

# Retrieve the shared keys of the workspace
data "azurerm_log_analytics_workspace_shared_keys" "law_keys" {
  resource_group_name = var.resource_group_name
  workspace_name      = azurerm_log_analytics_workspace.law.name
}

# Store the key as a secret in Key Vault
resource "azurerm_key_vault_secret" "law_primary_key" {
  name         = "log-analytics-primary-key"
  value        = data.azurerm_log_analytics_workspace_shared_keys.law_keys.primary_shared_key
  key_vault_id = data.azurerm_key_vault.existing_kv.id
}
